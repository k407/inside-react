<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="favicon.ico">
    <title>Document</title>
    <link rel="stylesheet" href="css/main.css">
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="app"></div>
    <script type="text/jsx">
      const api = {
        get(url) {
          switch (url) {
            case '/items':
              return new Promise((resolve, reject) => {
                setTimeout(() => {
                  resolve([
                    {
                      id: 1,
                      name: 'item_1',
                      price: 7,
                    },
                    {
                      id: 2,
                      name: 'item_2',
                      price: 9,
                    },
                    {
                      id: 3,
                      name: 'item_3',
                      price: 11,
                    },
                  ]);
                }, 1000);
              });
            default:
              throw new Error('404');
          }
        },
      };

      const initialState = {
        time: new Date(),
        items: null,
        placeholders: [
          {
            id: 1,
            tagName: 'p',
            className: 'placeholder_xsmall',
            innerText: '\u00A0',
          },
          {
            id: 2,
            tagName: 'p',
            className: 'placeholder_large',
            innerText: '\u00A0',
          },
          {
            id: 3,
            tagName: 'p',
            className: 'placeholder_small',
            innerText: '\u00A0',
          },
          {
            id: 4,
            tagName: 'p',
            className: 'placeholder_medium',
            innerText: '\u00A0',
          },
        ],
      };

      const SET_TIME = 'SET_TIME';
      const SET_ITEMS = 'SET_ITEMS';
      const CHANGE_ITEM_PRICE = 'CHANGE_ITEM_PRICE';

      function appReducer(state = initialState, action) {
        switch (action.type) {
          case SET_TIME:
            return {
              ...state,
              time: action.time,
            };
          case SET_ITEMS:
            return {
              ...state,
              items: action.items,
            };
          case CHANGE_ITEM_PRICE:
            return {
              ...state,
              items: state.items.map((item) => {
                if (item.id === action.id) {
                  return {
                    ...item,
                    price: action.price,
                  };
                }
                return item;
              }),
            };
          default:
            return state;
        }
      }

      class Store {
        constructor(reducer, initialState) {
          this.reducer = reducer;
          this.state = reducer(initialState, { type: null });
          this.listeners = [];
        }

        getState() {
          return this.state;
        }

        subscribe(listener) {
          this.listeners.push(listener);

          return () => {
            const index = this.listeners.indexOf(listener);
            this.listeners.splice(index, 1);
          };
        }

        dispatch(action) {
          this.state = this.reducer(this.state, action);
          this.listeners.forEach((listener) => listener());
        }
      }

      const store = new Store(appReducer);

      function App({ state }) {
        return (
          <div className="wrapper">
            <Header state={state} />
            <Items items={state.items} placeholders={state.placeholders} />
          </div>
        );
      }

      function Header({ state }) {
        return (
          <header className="header">
            <Logo />
            <Clock time={state.time} />
          </header>
        );
      }

      function Logo() {
        return <img className="logo" src="images/logo.png" alt="" />;
      }

      function Clock({ time }) {
        const isDay = time.getHours() >= 7 && time.getHours() <= 21;

        return (
          <div className="clock">
            <span className="value">{time.toLocaleTimeString()}</span>
            <img className="icon" src={isDay ? 'images/sun.png' : 'images/moon.png'} alt="" />
          </div>
        );
      }

      function Placeholder({ placeholder }) {
        return (
          <placeholder.tagName className={placeholder.className}>
            {placeholder.innerText}
          </placeholder.tagName>
        )
      }

      function Loading({ placeholders }) {
        return (
          <div className="placeholder">
            {placeholders.map((placeholder) => (
              <Placeholder placeholder={placeholder} key={placeholder.id} />
            ))}
          </div>
        );
      }

      function Items({items, placeholders}) {
        if (items === null) {
          return <Loading placeholders={placeholders} />;
        }

        return (
          <div className="items">
            {items.map((item) => (
              <Item item={item} key={item.id} />
            ))}
          </div>
        );
      }

      function Item({ item }) {
        return (
          <article className="item">
            <h2 className="item_name">{item.name}</h2>
            <div className="item_price">{item.price}</div>
          </article>
        );
      }

      function renderView(state) {
        ReactDOM.render(<App state={state} />, document.querySelector('#app'));
      }

      renderView(store.getState());

      store.subscribe(() => {
        renderView(store.getState());
      });

      setInterval(() => {
        store.dispatch({ type: SET_TIME, time: new Date() });
      }, 1000);

      const stream = {
        subscribe(channel, listener) {
          const match = /price-(\d+)/.exec(channel);

          if (match) {
            setInterval(() => {
              listener({
                id: parseInt(match[1]),
                price: Math.floor(Math.random() * 10 + 1),
              });
            }, 1000);
          }
        },
      };

      api.get('/items').then((items) => {
        store.dispatch({ type: SET_ITEMS, items });

        items.forEach((item) => {
          stream.subscribe(`price-${item.id}`, (data) => {
            store.dispatch({ type: CHANGE_ITEM_PRICE, id: data.id, price: data.price });
          });
        });
      });
    </script>
  </body>
</html>
