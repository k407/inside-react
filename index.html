<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="favicon.ico">
    <title>Document</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/redux@latest/dist/redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@8.0.1/dist/react-redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux-thunk@2.1.0/dist/redux-thunk.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
  </head>
  <body>
    <div id="app"></div>
    <script type="text/jsx">
      const api = {
        get(url) {
          switch (url) {
            case '/items':
              return new Promise((resolve, reject) => {
                setTimeout(() => {
                  if (Math.random() > 0.25) {
                    resolve([
                      {
                        id: 1,
                        name: 'item_1',
                        price: 7,
                        favorite: true,
                      },
                      {
                        id: 2,
                        name: 'item_2',
                        price: 9,
                        favorite: false,
                      },
                      {
                        id: 3,
                        name: 'item_3',
                        price: 11,
                        favorite: false,
                      },
                    ]);
                  } else {
                    reject(new Error('Connection error'));
                  }
                }, 1000);
              });
            default:
              throw new Error('404');
          }
        },
        post(url) {
          if (/^\/items\/(\d+)\/favorite$/.exec(url)) {
            return new Promise((resolve) => {
              setTimeout(() => {
                resolve({});
              }, 500);
            });
          }
          if (/^\/items\/(\d+)\/unfavorite$/.exec(url)) {
            return new Promise((resolve) => {
              setTimeout(() => {
                resolve({});
              }, 500);
            });
          }
          throw new Error('Unknown address');
        },
      };

      const stream = {
        subscribe(channel, listener) {
          const match = /price-(\d+)/.exec(channel);

          if (match) {
            const interval = setInterval(() => {
              listener({
                id: parseInt(match[1]),
                price: Math.floor(Math.random() * 10 + 1),
              });
            }, 400);
            return () => clearInterval(interval);
          }
        },
      };

      function App() {
        return (
          <div className="wrapper">
            <Header />
            <ItemsContainer />
          </div>
        );
      }

      function Header() {
        return (
          <header className="header">
            <Logo />
            <ClockContainer />
          </header>
        );
      }

      function Logo() {
        return <img className="logo" src="images/logo.png" alt="" />;
      }

      function ClockContainer() {
        const [time, setTime] = React.useState(new Date());

        React.useEffect(() => {
          const interval = setInterval(() => {
            setTime(new Date());
          }, 1000);

          return () => clearInterval(interval);
        }, [setTime]);

        return <Clock time={time} />;
      }

      function Clock({ time }) {
        const isDay = time.getHours() >= 7 && time.getHours() <= 21;

        return (
          <div className="clock">
            <span className="value">{time.toLocaleTimeString()}</span>
            <img className="icon" src={isDay ? 'images/sun.png' : 'images/moon.png'} alt="" />
          </div>
        );
      }

      function Placeholder({ placeholder }) {
        return (
          <placeholder.tagName className={placeholder.className}>
            {placeholder.innerText}
          </placeholder.tagName>
        )
      }

      function LoadingContainer() {
        const [placeholders, setPlaceholders] = React.useState([
          {
            id: 1,
            tagName: 'p',
            className: 'placeholder_xsmall',
            innerText: '\u00A0',
          },
          {
            id: 2,
            tagName: 'p',
            className: 'placeholder_large',
            innerText: '\u00A0',
          },
          {
            id: 3,
            tagName: 'p',
            className: 'placeholder_small',
            innerText: '\u00A0',
          },
          {
            id: 4,
            tagName: 'p',
            className: 'placeholder_medium',
            innerText: '\u00A0',
          },
        ]);

        return <Loading placeholders={placeholders} />;
      }

      function Loading({ placeholders }) {
        return (
          <div className="placeholder">
            {placeholders.map((placeholder) => (
              <Placeholder placeholder={placeholder} key={placeholder.id} />
            ))}
          </div>
        );
      }

      function AlertError({ message }) {
        return <div className="error">{message}</div>;
      }

      function ItemsContainer({ placeholders }) {
        const [itemsState, setItemsState] = React.useState({
          items: [],
          loading: false,
          loaded: false,
          error: null,
        });

        const { items, loading, loaded, error } = itemsState;

        React.useEffect(() => {
          if (!loaded && !loading && error === null) {
            setItemsState((itemsState) => ({
              ...itemsState,
              loading: true,
              loaded: false,
              error: null,
            }));
            api
              .get('/items')
              .then((items) => {
                setItemsState((itemsState) => ({
                  ...itemsState,
                  items,
                  loading: false,
                  loaded: true,
                  error: null,
                }));
              })
              .catch((error) => {
                setItemsState((itemsState) => ({
                  ...itemsState,
                  loading: false,
                  loaded: false,
                  error: error.message,
                }));
              });
          }
        }, [loaded, loading, error]);

        if (error !== null) {
          return <AlertError message={error} />;
        }

        if (loading) {
          return <LoadingContainer placeholders={placeholders} />;
        }

        if (!loaded) {
          return null;
        }

        const subscribe = (id) => {
          return stream.subscribe(`price-${id}`, (data) => {
            setItemsState((itemsState) => ({
              ...itemsState,
              items: itemsState.items.map((item) => {
                if (item.id === data.id) {
                  return {
                    ...item,
                    price: data.price,
                  };
                }
                return item;
              }),
            }));
          });
        };

        const favorite = (id) => {
          api.post(`/items/${id}/favorite`).then(() => {
            setItemsState((itemsState) => ({
              ...itemsState,
              items: itemsState.items.map((item) => {
                if (item.id === id) {
                  return {
                    ...item,
                    favorite: true,
                  };
                }
                return item;
              }),
            }));
          });
        };

        const unfavorite = (id) => {
          api.post(`/items/${id}/unfavorite`).then(() => {
            setItemsState((itemsState) => ({
              ...itemsState,
              items: itemsState.items.map((item) => {
                if (item.id === id) {
                  return {
                    ...item,
                    favorite: false,
                  };
                }
                return item;
              }),
            }));
          });
        };

        return <Items items={items} subscribe={subscribe} favorite={favorite} unfavorite={unfavorite} />;
      }

      function Items({ items, subscribe, favorite, unfavorite }) {
        return (
          <div className="items">
            {items.map((item) => (
              <ItemContainer item={item} subscribe={subscribe} favorite={favorite} unfavorite={unfavorite} key={item.id} />
            ))}
          </div>
        );
      }

      function ItemContainer({ item, subscribe, favorite, unfavorite }) {
        React.useEffect(() => {
          return subscribe(item.id);
        }, [item.id]);

        return <Item item={item} favorite={favorite} unfavorite={unfavorite} />;
      }

      function Item({ item, favorite, unfavorite }) {
        return (
          <article className={'item' + (item.favorite ? ' item_favorite' : '')}>
            <h2 className="item_name">{item.name}</h2>
            <div className="item_price">{item.price}</div>
            <Favorite
              active={item.favorite}
              id={item.id}
              favorite={() => favorite(item.id)}
              unfavorite={() => unfavorite(item.id)}
            />
          </article>
        );
      }

      function Favorite({ active, favorite, unfavorite }) {
        return active ? (
          <button type="button" className="unfavorite" onClick={unfavorite}>
            <img className="favorite_icon" src="images/heart-sharp.png" alt="" /> Unfavorite
          </button>
        ) : (
          <button type="button" className="favorite" onClick={favorite}>
            <img className="favorite_icon" src="images/heart-outline.png" alt="" /> Favorite
          </button>
        );
      }

      ReactDOM.render(<App />, document.querySelector('#app'));
    </script>
  </body>
</html>
